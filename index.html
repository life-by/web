<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Three-Piece Shop — Gallery & Video</title>
  <style>
    .details-images img {
  width: 100%;
  height: auto;
  display: block;
  margin-bottom: 10px;
}

    :root{
      --bg:#f5f8fb; --card:#fff; --accent:#0d6efd; --accent2:#198754;
      --muted:#6b7280; --radius:12px; --shadow:0 8px 28px rgba(11,22,40,0.06);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family: "Inter", "Noto Sans Bengali", Arial, sans-serif;background:var(--bg);color:#0b1220}
    .wrap{max-width:1100px;margin:20px auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    h1{margin:0;font-size:20px}
    .sub{color:var(--muted);font-size:13px;margin-top:4px}
    .actions{display:flex;gap:8px}
    button{border:0;cursor:pointer;border-radius:10px;padding:10px 14px;font-weight:700}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff}
    .btn-ghost{background:transparent;border:1px solid rgba(13,110,253,0.12);color:var(--accent)}
    .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
    .products{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .product{border-radius:10px;overflow:hidden;border:1px solid #eef6fa;background:#fff;display:flex;flex-direction:column;transition:transform .12s}
    .product:hover{transform:translateY(-6px)}
    .product img{width:100%;height:170px;object-fit:cover;background:#eef6f9}
    .p-body{padding:12px;flex:1;display:flex;flex-direction:column}
    .p-title{font-weight:700;margin:0 0 6px}
    .p-price{color:var(--accent);font-weight:800;margin-bottom:8px}
    .p-actions{display:flex;gap:8px;margin-top:auto}
    .small{padding:8px 10px;border-radius:8px;font-size:13px}
    .small.secondary{background:#f3fbfd;color:var(--accent);border:1px solid rgba(6,142,173,0.06)}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input, textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef3;font-size:14px}
    .modal-back{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:60}
    .modal{width:100%;max-width:820px;background:#fff;padding:18px;border-radius:12px;box-shadow:0 12px 40px rgba(2,6,23,0.18)}
    .close-x{background:transparent;border:none;font-size:20px;position:absolute;right:18px;top:18px;cursor:pointer}
    .gallery{display:flex;gap:8px;align-items:center}
    .thumb{width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid #eef6f9}
    .main-media{width:100%;height:360px;background:#000;border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .main-media img{width:100%;height:100%;object-fit:cover}
    .nav-btn{background:rgba(255,255,255,0.8);border-radius:8px;padding:8px;border:0;cursor:pointer}
    @media (max-width:720px){ .product img{height:140px} .main-media{height:220px} }
    .muted{color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Three-Piece Shop</h1>
        <div class="sub">Details এ multiple images ও video + Commission View আলাদাভাবে</div>
      </div>
      <div class="actions">
        <button id="commissionBtn" class="btn-ghost">Commission View</button>
        <button id="adminBtn" class="btn-primary">Admin Login</button>
      </div>
    </header>

    <main class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <h3 style="margin:0">Products</h3>
        <div class="muted">Local demo — সব ডেটা আপনার ব্রাউজারে</div>
      </div>

      <div id="productsGrid" class="products"></div>
    </main>
  </div>

  <!-- modal -->
  <div id="modalRoot" class="modal-back">
    <div class="modal" role="dialog" aria-modal="true" id="modalBox" style="position:relative">
      <button class="close-x" id="modalClose">&times;</button>
      <div id="modalContent"></div>
    </div>
  </div>

<script>
  // storage keys
  var KEY='threepiece_gallery_v1', PW_KEY='threepiece_gallery_pw';
  function defaultState(){
    return {
      products:[
        {id:'p'+Date.now(), name:'Royal Black 3-piece', images:[], imageMain:'', price:2500, commissionPercent:10, video:'', videoType:''},
        {id:'p'+(Date.now()+1), name:'Classic Navy 3-piece', images:[], imageMain:'', price:2200, commissionPercent:8, video:'', videoType:''}
      ],
      sales:[]
    };
  }
  function load(){ var r=localStorage.getItem(KEY); if(!r){ var s=defaultState(); localStorage.setItem(KEY,JSON.stringify(s)); if(!localStorage.getItem(PW_KEY)) localStorage.setItem(PW_KEY,'admin123'); return s;} return JSON.parse(r); }
  function save(s){ localStorage.setItem(KEY, JSON.stringify(s)); }
  var state=load(), isAdmin=false;

  // helpers
  function $(id){ return document.getElementById(id); }
  function money(x){ return '৳' + Number(x||0).toFixed(2); }
  function findP(id){ return state.products.find(function(p){ return p.id===id; }); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g,function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

  // modal controls
  var modalRoot=$('modalRoot'), modalContent=$('modalContent'), modalClose=$('modalClose');
  function openModal(nodeOrHtml){ modalRoot.style.display='flex'; if(typeof nodeOrHtml==='string') modalContent.innerHTML=nodeOrHtml; else { modalContent.innerHTML=''; modalContent.appendChild(nodeOrHtml); } }
  function closeModal(){ modalRoot.style.display='none'; modalContent.innerHTML=''; }
  modalClose.onclick = closeModal; modalRoot.onclick = function(e){ if(e.target===modalRoot) closeModal(); };

  // render products
  function renderProducts(){
    var wrap=$('productsGrid'); wrap.innerHTML='';
    if(state.products.length===0){ wrap.innerHTML='<div class="muted">কোনো প্রোডাক্ট নেই — Admin লগইন করে যোগ করুন</div>'; return; }
    state.products.forEach(function(p){
      var card=document.createElement('div'); card.className='product';
      var img=document.createElement('img'); img.src = p.imageMain || (p.images && p.images[0]) || 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="800" height="600"><rect width="100%" height="100%" fill="#eef6f9"/><text x="50%" y="50%" font-size="20" text-anchor="middle" fill="#99b3bf">No Image</text></svg>');
      var body=document.createElement('div'); body.className='p-body';
      var title=document.createElement('div'); title.className='p-title'; title.textContent = p.name;
      var price=document.createElement('div'); price.className='p-price'; price.textContent = money(p.price);
      var actions=document.createElement('div'); actions.className='p-actions';
      var detailsBtn=document.createElement('button'); detailsBtn.className='small secondary'; detailsBtn.textContent='Details';
      detailsBtn.onclick = function(){ showDetails(p.id); };
      actions.appendChild(detailsBtn);

      if(isAdmin){
        var edit=document.createElement('button'); edit.className='small'; edit.textContent='Edit';
        edit.onclick = function(){ openModal(productForm(p)); };
        var del=document.createElement('button'); del.className='small secondary'; del.textContent='Delete';
        del.onclick = function(){ if(confirm('প্রোডাক্ট মুছবেন?')){ state.products = state.products.filter(function(x){ return x.id!==p.id }); save(state); renderProducts(); openModal(adminPanel()); } };
        actions.appendChild(edit); actions.appendChild(del);
      }

      body.appendChild(title); body.appendChild(price); body.appendChild(actions);
      card.appendChild(img); card.appendChild(body);
      wrap.appendChild(card);
    });
  }

  // Commission View (public) — shows commission amounts and % for each product
  $('commissionBtn').addEventListener('click', function(){
    var node=document.createElement('div'); var h=document.createElement('h3'); h.textContent='Commission View'; node.appendChild(h); node.appendChild(document.createElement('hr'));
    if(state.products.length===0){ node.appendChild(createMuted('কোনো প্রোডাক্ট নেই')); openModal(node); return; }
    var grid=document.createElement('div'); grid.style.display='grid'; grid.style.gap='10px';
    state.products.forEach(function(p){
      var r=document.createElement('div'); r.className='card'; r.style.padding='10px';
      var name=document.createElement('div'); name.innerHTML = '<strong>' + escapeHtml(p.name) + '</strong>';
      var price=document.createElement('div'); price.className='muted'; price.textContent = 'Price: ' + money(p.price || 0);
      var percent = p.commissionPercent != null ? Number(p.commissionPercent) : 0;
      var comm = +((p.price||0) * percent / 100);
      var line=document.createElement('div'); line.style.marginTop='6px'; line.innerHTML = 'Commission: ' + percent + '% — <strong>' + money(comm) + '</strong>';
      r.appendChild(name); r.appendChild(price); r.appendChild(line); grid.appendChild(r);
    });
    node.appendChild(grid); openModal(node);
  });

  function createMuted(text){ var d=document.createElement('div'); d.className='muted'; d.style.marginTop='8px'; d.textContent=text; return d; }

  // Admin login & panel
  $('adminBtn').addEventListener('click', showAdminLogin);
  function showAdminLogin(){
    var node=document.createElement('div'); var h=document.createElement('h3'); h.textContent='Admin Login';
    var f=document.createElement('div'); f.style.marginTop='8px'; f.innerHTML = '<label>পাসওয়ার্ড</label><input id="pwInput" type="password" placeholder="Enter admin password"/>';
    var btn=document.createElement('button'); btn.textContent='Login'; btn.className='btn-primary'; btn.style.marginTop='12px';
    btn.onclick=function(){ var v=document.getElementById('pwInput').value||''; var real = localStorage.getItem(PW_KEY) || 'admin123'; if(v===real){ isAdmin=true; closeModal(); onAdminEnter(); } else alert('পাসওয়ার্ড সঠিক নয়'); };
    node.appendChild(h); node.appendChild(f); node.appendChild(btn); openModal(node);
  }

  function onAdminEnter(){
    renderProducts();
    openModal(adminPanel());
  }

  function adminPanel(){
    var root=document.createElement('div'); var h=document.createElement('h3'); h.textContent='Admin Panel'; root.appendChild(h); root.appendChild(document.createElement('hr'));
    var bar=document.createElement('div'); bar.style.display='flex'; bar.style.gap='8px'; bar.style.flexWrap='wrap';
    var addBtn=document.createElement('button'); addBtn.textContent='Add Product'; addBtn.className='btn-primary small'; addBtn.onclick=function(){ openModal(productForm()); };
    var dashboardBtn=document.createElement('button'); dashboardBtn.textContent='Dashboard & Sales'; dashboardBtn.className='small secondary'; dashboardBtn.onclick=function(){ openModal(dashboardView()); };
    var changePw=document.createElement('button'); changePw.textContent='Change Password'; changePw.className='small'; changePw.onclick=function(){ changePassword(); };
    var logout=document.createElement('button'); logout.textContent='Logout Admin'; logout.className='small secondary'; logout.onclick=function(){ if(confirm('Admin লগআউট করবেন?')){ isAdmin=false; closeModal(); renderProducts(); } };
    bar.appendChild(addBtn); bar.appendChild(dashboardBtn); bar.appendChild(changePw); bar.appendChild(logout); root.appendChild(bar);

    // product quick list
    var list=document.createElement('div'); list.style.marginTop='12px';
    state.products.forEach(function(p){
      var row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='8px 0'; row.style.borderBottom='1px dashed #eef6f9';
      var left=document.createElement('div'); left.innerHTML = '<strong>' + escapeHtml(p.name) + '</strong><div class="muted">Price: '+ money(p.price) + ' • Comm: ' + (p.commissionPercent!=null? p.commissionPercent+'%':'Not set') + '</div>';
      var right=document.createElement('div'); var e=document.createElement('button'); e.className='small'; e.textContent='Edit'; e.onclick=function(){ openModal(productForm(p)); }; var d=document.createElement('button'); d.className='small secondary'; d.textContent='Delete'; d.onclick=function(){ if(confirm('Delete product?')){ state.products=state.products.filter(function(x){ return x.id!==p.id }); save(state); renderProducts(); openModal(adminPanel()); } };
      right.appendChild(e); right.appendChild(d); row.appendChild(left); row.appendChild(right); list.appendChild(row);
    });
    root.appendChild(list); return root;
  }

  function changePassword(){
    var cur=prompt('Current password:');
    if(cur !== (localStorage.getItem(PW_KEY) || 'admin123')){ alert('Current password ভুল'); return; }
    var np=prompt('New password (min 4 char):');
    if(!np || np.length<4){ alert('Invalid'); return; }
    localStorage.setItem(PW_KEY,np); alert('Password updated');
  }

  // product add/edit form (with multi-image & video)
  function productForm(prod){
    var editing = !!prod;
    var wrapper=document.createElement('div');
    var title=document.createElement('h3'); title.textContent = editing ? 'Edit Product' : 'Add Product'; wrapper.appendChild(title); wrapper.appendChild(document.createElement('hr'));
    var form=document.createElement('div');

    form.innerHTML =
      '<label>Product Name</label><input id="f_name" type="text" />' +
      '<label style="margin-top:8px">Price (৳)</label><input id="f_price" type="number" />' +
      '<label style="margin-top:8px">Commission (%)</label><input id="f_comm" type="number" placeholder="e.g., 10" />' +

      '<hr style="margin:12px 0"/>' +
      '<label>Image Upload (multiple files)</label><input id="f_images" type="file" accept="image/*" multiple />' +
      '<div style="margin-top:8px"><label>Add image by URL</label><input id="f_img_url" type="text" placeholder="Image URL and press Add" /></div>' +
      '<div style="display:flex;gap:8px;margin-top:8px"><button id="addImgUrlBtn" class="small secondary">Add URL</button><div class="muted" style="align-self:center">Added images will show below</div></div>' +

      '<div id="imagesPreview" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:10px"></div>' +

      '<hr style="margin:12px 0"/>' +
      '<label>Video (YouTube link or direct video URL)</label><input id="f_video" type="text" placeholder="Paste YouTube URL or direct video URL" />' +
      '<div class="muted" style="margin-top:6px">Example YouTube: https://www.youtube.com/watch?v=VIDEO_ID</div>'
    ;

    wrapper.appendChild(form);

    var btn=document.createElement('button'); btn.textContent = editing ? 'Save Changes' : 'Add Product'; btn.className='btn-primary'; btn.style.marginTop='12px';
    btn.onclick = function(){
      var name = wrapper.querySelector('#f_name').value.trim();
      var price = parseFloat(wrapper.querySelector('#f_price').value);
      var commVal = wrapper.querySelector('#f_comm').value.trim();
      var comm = commVal === '' ? null : Number(commVal);
      if(!name || isNaN(price)){ alert('নাম ও সঠিক দাম দিন'); return; }
      // collect images from preview area
      var imgs = [];
      wrapper.querySelectorAll('#imagesPreview img').forEach(function(im){ imgs.push(im.dataset.src); });
      var video = wrapper.querySelector('#f_video').value.trim();
      var videoType = detectVideoType(video);

      if(editing){
        prod.name = name; prod.price = price; prod.commissionPercent = comm;
        prod.images = imgs; if(imgs.length>0) prod.imageMain = imgs[0]; prod.video = video; prod.videoType = videoType;
      } else {
        var id='p'+Date.now();
        state.products.push({id:id,name:name,price:price,commissionPercent:comm,images:imgs,imageMain:(imgs[0]||''),video:video,videoType:videoType});
      }
      save(state); closeModal(); renderProducts();
    };

    wrapper.appendChild(btn);

    // prefill
    setTimeout(function(){
      if(editing){
        wrapper.querySelector('#f_name').value = prod.name||'';
        wrapper.querySelector('#f_price').value = prod.price||'';
        wrapper.querySelector('#f_comm').value = prod.commissionPercent != null ? prod.commissionPercent : '';
        wrapper.querySelector('#f_video').value = prod.video || '';
        // render images
        var prev = wrapper.querySelector('#imagesPreview');
        prev.innerHTML='';
        (prod.images || []).forEach(function(src){ var im=document.createElement('img'); im.src=src; im.className='thumb'; im.style.cursor='pointer'; im.dataset.src=src; prev.appendChild(im); });
      }
    },0);

    // handle file upload -> convert to data URLs and add to preview
    wrapper.querySelector('#f_images').addEventListener('change', function(e){
      var files = Array.prototype.slice.call(e.target.files || []);
      if(files.length===0) return;
      files.forEach(function(file){
        var reader = new FileReader();
        reader.onload = function(ev){ addPreviewImage(ev.target.result); }
        reader.readAsDataURL(file);
      });
      e.target.value=''; // reset
    });

    // add URL button
    wrapper.querySelector('#addImgUrlBtn').addEventListener('click', function(e){
      e.preventDefault();
      var url = wrapper.querySelector('#f_img_url').value.trim();
      if(!url){ alert('URL দিন'); return; }
      addPreviewImage(url);
      wrapper.querySelector('#f_img_url').value='';
    });

    function addPreviewImage(src){
      var prev = wrapper.querySelector('#imagesPreview');
      var imgEl = document.createElement('img'); imgEl.src = src; imgEl.className='thumb'; imgEl.dataset.src = src;
      // clicking thumbnail removes it (quick edit)
      imgEl.title = 'Click to remove';
      imgEl.style.cursor='pointer';
      imgEl.onclick = function(){ if(confirm('ছবি মুছবেন?')) imgEl.remove(); };
      prev.appendChild(imgEl);
    }

    return wrapper;
  }

  function detectVideoType(url){
    if(!url) return '';
    try{
      if(url.indexOf('youtube.com')>-1 || url.indexOf('youtu.be')>-1) return 'youtube';
      if(url.match(/\.(mp4|webm|ogg)(\?.*)?$/i)) return 'direct';
    }catch(e){}
    return 'direct';
  }

  // details modal: gallery + video (if present)
  function showDetails(id){
    var p=findP(id); if(!p) return;
    var node=document.createElement('div');
    var h=document.createElement('h3'); h.textContent = p.name;
    node.appendChild(h); node.appendChild(document.createElement('hr'));

    // media area
    var mediaWrap=document.createElement('div');
    mediaWrap.style.display='grid';
    mediaWrap.style.gap='10px';

    var mainDiv=document.createElement('div'); mainDiv.className='main-media';
    var mediaIndex = 0;
    var mediaList = [];
    // images first
    if(p.imageMain) mediaList.push({type:'image', src:p.imageMain});
    (p.images || []).forEach(function(i){ if(i && i !== p.imageMain) mediaList.push({type:'image', src:i}); });
    // video appended last (playable)
    if(p.video) mediaList.push({type:'video', src:p.video, vtype:p.videoType});

    if(mediaList.length===0){
      mainDiv.innerHTML = '<div class="muted">কোনো মিডিয়া নেই</div>';
    } else {
      renderMainMedia();
    }

    // thumbnails
    var thumbsDiv=document.createElement('div'); thumbsDiv.className='gallery';
    thumbsDiv.style.flexWrap='wrap';

    mediaList.forEach(function(m, idx){
      var t = document.createElement('img'); t.className='thumb'; t.style.width='84px'; t.style.height='84px'; t.style.objectFit='cover';
      if(m.type==='image') t.src = m.src;
      else if(m.type==='video') {
        // create a thumbnail placeholder for video
        t.src = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="300" height="200"><rect width="100%" height="100%" fill="#000"/><text x="50%" y="50%" fill="#fff" font-size="18" text-anchor="middle">VIDEO</text></svg>');
      }
      t.style.cursor='pointer';
      t.onclick = function(){ mediaIndex = idx; renderMainMedia(); };
      thumbsDiv.appendChild(t);
    });

    // prev/next
    var navWrap=document.createElement('div'); navWrap.style.display='flex'; navWrap.style.justifyContent='space-between'; navWrap.style.alignItems='center';
    var prevBtn=document.createElement('button'); prevBtn.className='nav-btn'; prevBtn.textContent='◀ Prev'; prevBtn.onclick=function(){ if(mediaList.length===0) return; mediaIndex = (mediaIndex-1+mediaList.length)%mediaList.length; renderMainMedia(); };
    var nextBtn=document.createElement('button'); nextBtn.className='nav-btn'; nextBtn.textContent='Next ▶'; nextBtn.onclick=function(){ if(mediaList.length===0) return; mediaIndex = (mediaIndex+1)%mediaList.length; renderMainMedia(); };
    navWrap.appendChild(prevBtn); navWrap.appendChild(nextBtn);

    function renderMainMedia(){
      mainDiv.innerHTML='';
      var cur = mediaList[mediaIndex];
      if(!cur){ mainDiv.innerHTML='<div class="muted">No media</div>'; return; }
      if(cur.type==='image'){
        var im=document.createElement('img'); im.src=cur.src; mainDiv.appendChild(im);
      } else if(cur.type==='video'){
        // if youtube, embed iframe; else show video tag
        if(detectVideoType(cur.src) === 'youtube'){
          var vidId = extractYouTubeID(cur.src);
          var iframe=document.createElement('iframe'); iframe.width='100%'; iframe.height='100%'; iframe.src='https://www.youtube.com/embed/' + vidId + '?rel=0'; iframe.frameBorder=0; iframe.allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture'; iframe.allowFullscreen=true; mainDiv.appendChild(iframe);
        } else {
          var v=document.createElement('video'); v.controls=true; v.src=cur.src; v.style.width='100%'; v.style.height='100%'; v.style.objectFit='contain'; mainDiv.appendChild(v);
        }
      }
    }

    node.appendChild(mainDiv);
    node.appendChild(navWrap);
    node.appendChild(thumbsDiv);

    // description + sell simulate (admin only)
    var info=document.createElement('div'); info.style.marginTop='12px';
    info.innerHTML = '<div class="muted">Price: '+ money(p.price) +'</div>';
    var sellBtn=document.createElement('button'); sellBtn.textContent='Sell (simulate)'; sellBtn.className='btn-primary'; sellBtn.style.marginTop='8px';
    sellBtn.onclick = function(){ simulateSale(p.id); closeModal(); };
    info.appendChild(sellBtn);
    node.appendChild(info);

    openModal(node);
  }

  function extractYouTubeID(url){
    if(!url) return '';
    var m = url.match(/(?:v=|\/embed\/|youtu\.be\/|\/v\/)([A-Za-z0-9_\-]{6,})/);
    return m ? m[1] : (function(){ try{ var u = new URL(url); if(u.hostname==='youtu.be') return u.pathname.slice(1);}catch(e){} return ''; })();
  }

  // simulate sale (records commission, used in admin)
  function simulateSale(pid){
    var p=findP(pid); if(!p) return alert('Product not found');
    var percent = p.commissionPercent != null ? Number(p.commissionPercent) : 0;
    var comm = +(p.price * percent / 100);
    var sale = { id:'s'+Date.now(), productId:p.id, productName:p.name, price:p.price, commissionPercent:percent, commission:comm, when:Date.now() };
    state.sales.push(sale); save(state); alert('Sale recorded — Commission: ' + money(comm) + ' ('+percent+'%)');
  }

  // dashboard & sales view for admin
  function dashboardView(){
    var wrap=document.createElement('div'); var h=document.createElement('h3'); h.textContent='Dashboard & Sales'; wrap.appendChild(h); wrap.appendChild(document.createElement('hr'));
    var totalP=state.products.length, totalS=state.sales.length, rev=state.sales.reduce(function(a,s){return a + (s.price||0);},0);
    var stats=document.createElement('div'); stats.style.display='flex'; stats.style.gap='12px'; stats.style.flexWrap='wrap';
    stats.innerHTML = '<div style="min-width:120px"><strong>'+ totalP +'</strong><div class="muted">Products</div></div>'
                    + '<div style="min-width:120px"><strong>'+ totalS +'</strong><div class="muted">Sales</div></div>'
                    + '<div style="min-width:140px"><strong>'+ money(rev) +'</strong><div class="muted">Revenue</div></div>';
    wrap.appendChild(stats); wrap.appendChild(document.createElement('hr'));
    var list=document.createElement('div');
    if(state.sales.length===0) list.appendChild(createMuted('কোনো বিক্রয় রেকর্ড নেই'));
    else state.sales.slice().reverse().forEach(function(s){ var r=document.createElement('div'); r.style.padding='8px 0'; r.style.borderBottom='1px dashed #eef6f9'; r.innerHTML = '<strong>' + escapeHtml(s.productName) + '</strong> — ' + money(s.price) + '<div class="muted">Commission: ' + money(s.commission) + ' (' + s.commissionPercent + '%) • ' + (new Date(s.when)).toLocaleString() + '</div>'; list.appendChild(r); });
    wrap.appendChild(list); return wrap;
  }

  // product form pop-up for add/edit, includes multi-image upload and video input
  function productForm(prod){
    var editing = !!prod;
    var wrapper=document.createElement('div'); var title=document.createElement('h3'); title.textContent = editing ? 'Edit Product' : 'Add Product'; wrapper.appendChild(title); wrapper.appendChild(document.createElement('hr'));
    var form=document.createElement('div');
    form.innerHTML =
      '<label>Product Name</label><input id="f_name" type="text" />' +
      '<label style="margin-top:8px">Price (৳)</label><input id="f_price" type="number" />' +
      '<label style="margin-top:8px">Commission (%)</label><input id="f_comm" type="number" placeholder="e.g., 10" />' +
      '<hr style="margin:12px 0"/>' +
      '<label>Upload Images (multiple)</label><input id="f_images" type="file" accept="image/*" multiple />' +
      '<label style="margin-top:8px">Or add image URL</label><div style="display:flex;gap:8px"><input id="f_img_url" type="text" placeholder="Image URL"/><button id="addImgUrlBtn" class="small secondary">Add</button></div>' +
      '<div id="imagesPreview" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:10px"></div>' +
      '<hr style="margin:12px 0"/>' +
      '<label>Video (YouTube link or direct video URL)</label><input id="f_video" type="text" placeholder="YouTube or direct video URL"/>'
    ;
    wrapper.appendChild(form);
    var btn=document.createElement('button'); btn.textContent = editing ? 'Save Changes' : 'Add Product'; btn.className='btn-primary'; btn.style.marginTop='12px';
    btn.onclick = function(){
      var name = wrapper.querySelector('#f_name').value.trim(), price=parseFloat(wrapper.querySelector('#f_price').value), commVal=wrapper.querySelector('#f_comm').value.trim(), comm = commVal===''?null:Number(commVal);
      if(!name || isNaN(price)){ alert('নাম ও সঠিক দাম দিন'); return; }
      var imgs=[]; wrapper.querySelectorAll('#imagesPreview img').forEach(function(im){ imgs.push(im.dataset.src); });
      var video = wrapper.querySelector('#f_video').value.trim(); var vtype = detectVideoType(video);
      if(editing){ prod.name=name; prod.price=price; prod.commissionPercent=comm; prod.images=imgs; if(imgs.length>0) prod.imageMain=imgs[0]; prod.video=video; prod.videoType=vtype; }
      else { var id='p'+Date.now(); state.products.push({id:id,name:name,price:price,commissionPercent:comm,images:imgs,imageMain:(imgs[0]||''),video:video,videoType:vtype}); }
      save(state); closeModal(); renderProducts();
    };
    wrapper.appendChild(btn);

    // prefill
    setTimeout(function(){
      if(editing){
        wrapper.querySelector('#f_name').value = prod.name||'';
        wrapper.querySelector('#f_price').value = prod.price||'';
        wrapper.querySelector('#f_comm').value = prod.commissionPercent!=null?prod.commissionPercent:'';
        wrapper.querySelector('#f_video').value = prod.video||'';
        var prev = wrapper.querySelector('#imagesPreview'); prev.innerHTML=''; (prod.images||[]).forEach(function(src){ addPreview(src, prev); });
      }
    },0);

    // file input handling
    wrapper.querySelector('#f_images').addEventListener('change', function(e){
      var files = Array.prototype.slice.call(e.target.files || []);
      if(files.length===0) return;
      files.forEach(function(file){
        var reader=new FileReader();
        reader.onload=function(ev){ addPreview(ev.target.result, wrapper.querySelector('#imagesPreview')); }
        reader.readAsDataURL(file);
      });
      e.target.value='';
    });

    wrapper.querySelector('#addImgUrlBtn').addEventListener('click', function(e){ e.preventDefault(); var url = wrapper.querySelector('#f_img_url').value.trim(); if(!url){ alert('URL দিন'); return; } addPreview(url, wrapper.querySelector('#imagesPreview')); wrapper.querySelector('#f_img_url').value=''; });

    function addPreview(src, parent){
      var imgEl=document.createElement('img'); imgEl.src = src; imgEl.className='thumb'; imgEl.dataset.src=src; imgEl.style.cursor='pointer'; imgEl.title='Click to remove'; imgEl.onclick=function(){ if(confirm('ছবি মুছবেন?')) imgEl.remove(); };
      parent.appendChild(imgEl);
    }

    return wrapper;
  }

  // detect video type
  function detectVideoType(url){
    if(!url) return '';
    if(url.indexOf('youtube.com')>-1 || url.indexOf('youtu.be')>-1) return 'youtube';
    if(url.match(/\.(mp4|webm|ogg)(\?.*)?$/i)) return 'direct';
    return 'direct';
  }

  // init render
  renderProducts();

  // keyboard convenience
  document.addEventListener('keydown', function(e){ if((e.key==='A' || e.key==='a') && !isAdmin) showAdminLogin(); });

  // dashboard etc (admin)
  function dashboardView(){ return dashboardViewImpl(); }
  function dashboardViewImpl(){
    var wrap=document.createElement('div'); var h=document.createElement('h3'); h.textContent='Dashboard & Sales'; wrap.appendChild(h); wrap.appendChild(document.createElement('hr'));
    var totalP=state.products.length, totalS=state.sales.length, rev=state.sales.reduce(function(a,s){return a + (s.price||0);},0);
    var stats=document.createElement('div'); stats.style.display='flex'; stats.style.gap='12px'; stats.style.flexWrap='wrap';
    stats.innerHTML = '<div style="min-width:120px"><strong>'+ totalP +'</strong><div class="muted">Products</div></div>'
                    + '<div style="min-width:120px"><strong>'+ totalS +'</strong><div class="muted">Sales</div></div>'
                    + '<div style="min-width:140px"><strong>'+ money(rev) +'</strong><div class="muted">Revenue</div></div>';
    wrap.appendChild(stats); wrap.appendChild(document.createElement('hr'));
    var list=document.createElement('div');
    if(state.sales.length===0) list.appendChild(createMuted('কোনো বিক্রয় রেকর্ড নেই'));
    else state.sales.slice().reverse().forEach(function(s){ var r=document.createElement('div'); r.style.padding='8px 0'; r.style.borderBottom='1px dashed #eef6f9'; r.innerHTML = '<strong>' + escapeHtml(s.productName) + '</strong> — ' + money(s.price) + '<div class="muted">Commission: ' + money(s.commission) + ' (' + s.commissionPercent + '%) • ' + (new Date(s.when)).toLocaleString() + '</div>'; list.appendChild(r); });
    wrap.appendChild(list); return wrap;
  }

  // Admin panel reuse (for after login)
  function adminPanel(){ return adminPanelImpl(); }
  function adminPanelImpl(){
    var root=document.createElement('div'); var h=document.createElement('h3'); h.textContent='Admin Panel'; root.appendChild(h); root.appendChild(document.createElement('hr'));
    var bar=document.createElement('div'); bar.style.display='flex'; bar.style.gap='8px'; bar.style.flexWrap='wrap';
    var addBtn=document.createElement('button'); addBtn.textContent='Add Product'; addBtn.className='btn-primary small'; addBtn.onclick=function(){ openModal(productForm()); };
    var dashboardBtn=document.createElement('button'); dashboardBtn.textContent='Dashboard & Sales'; dashboardBtn.className='small secondary'; dashboardBtn.onclick=function(){ openModal(dashboardView()); };
    var changePw=document.createElement('button'); changePw.textContent='Change Password'; changePw.className='small'; changePw.onclick=function(){ changePassword(); };
    var logout=document.createElement('button'); logout.textContent='Logout Admin'; logout.className='small secondary'; logout.onclick=function(){ if(confirm('Admin logout?')){ isAdmin=false; closeModal(); renderProducts(); } };
    bar.appendChild(addBtn); bar.appendChild(dashboardBtn); bar.appendChild(changePw); bar.appendChild(logout); root.appendChild(bar);

    var list=document.createElement('div'); list.style.marginTop='12px';
    state.products.forEach(function(p){ var row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='8px 0'; row.style.borderBottom='1px dashed #eef6f9'; var left=document.createElement('div'); left.innerHTML = '<strong>' + escapeHtml(p.name) + '</strong><div class="muted">Price: '+ money(p.price) + ' • Comm: ' + (p.commissionPercent!=null? p.commissionPercent+'%':'Not set') + '</div>'; var right=document.createElement('div'); var e=document.createElement('button'); e.className='small'; e.textContent='Edit'; e.onclick=function(){ openModal(productForm(p)); }; var d=document.createElement('button'); d.className='small secondary'; d.textContent='Delete'; d.onclick=function(){ if(confirm('Delete product?')){ state.products=state.products.filter(function(x){ return x.id!==p.id }); save(state); renderProducts(); openModal(adminPanel()); } }; right.appendChild(e); right.appendChild(d); row.appendChild(left); row.appendChild(right); list.appendChild(row); });
    root.appendChild(list); return root;
  }

  function changePassword(){ var cur=prompt('Current password:'); if(cur !== (localStorage.getItem(PW_KEY) || 'admin123')){ alert('Current password ভুল'); return; } var np=prompt('New password (min 4 char):'); if(!np || np.length<4){ alert('Invalid'); return; } localStorage.setItem(PW_KEY,np); alert('Password updated'); }

  // small utility: allow admin shortcut
  document.addEventListener('keydown', function(e){ if((e.key==='A' || e.key==='a') && !isAdmin) showAdminLogin(); });

</script>
</body>
</html>
